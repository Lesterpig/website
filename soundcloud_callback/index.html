<!DOCTYPE html>

<html>

  <head>
    <meta charset="UTF-8">
    <title>Connect with SoundCloud</title>
    <script type="text/javascript">
      const allowedOrigins = [
        'https://mopidy.com', 'https://auth.mopidy.com',
        'http://localhost:4000', 'http://localhost:5000'];

      const parse = value => new Map(value.substr(1).split("&").map(v => v.split("=", 2)));
      const get = (map, key) => map.has(key) ? decodeURIComponent(map.get(key)) : null;
      const hash = parse(window.location.hash);
      const query = parse(window.location.search);

      const data = {
        auth_token: get(hash, "access_token"),
        error: get(query, "error_code"),
        error_description: get(query, "error_description"),
      }

      // Support custom handling using post messages.
      window.addEventListener("message", event => {
        if (allowedOrigins.indexOf(event.origin) >= 0) {
          event.source.postMessage(data, event.origin);
        }
      });

      try {
        // Continue supporting SDK based callback.
        if (window.opener && window.opener.SC) {
          window.opener.setTimeout(window.opener.SC.connectCallback, 1);
        }
      } catch(error) {
        console.log(error);
      }

      setInterval(_ => {
        if (!window.opener || window.opener.closed) {
          window.self.close();
        }
      }, 1000);
    </script>
  </head>

  <body>
    <p>This popup should automatically close in a few seconds.</p>
  </body>

</html>
